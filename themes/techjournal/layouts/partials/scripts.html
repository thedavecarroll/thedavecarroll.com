{{/* Theme toggle script */}}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const toggle = document.getElementById('theme-toggle');
  if (!toggle) return;

  const lightIcon = toggle.querySelector('.theme-icon-light');
  const darkIcon = toggle.querySelector('.theme-icon-dark');

  function getStoredTheme() {
    return localStorage.getItem('theme');
  }

  function getEffectiveTheme() {
    const stored = getStoredTheme();
    if (stored === 'dark' || stored === 'light') return stored;
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }

  function applyTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    if (theme === 'dark') {
      if (lightIcon) lightIcon.classList.add('hidden');
      if (darkIcon) darkIcon.classList.remove('hidden');
    } else {
      if (lightIcon) lightIcon.classList.remove('hidden');
      if (darkIcon) darkIcon.classList.add('hidden');
    }
  }

  // Initialize
  applyTheme(getEffectiveTheme());

  // Toggle handler
  toggle.addEventListener('click', function() {
    const current = getEffectiveTheme();
    const newTheme = current === 'dark' ? 'light' : 'dark';
    localStorage.setItem('theme', newTheme);
    applyTheme(newTheme);
  });

  // Listen for system theme changes (only applies if no explicit preference)
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
    if (!getStoredTheme()) {
      applyTheme(e.matches ? 'dark' : 'light');
    }
  });
});
</script>

{{/* Mobile menu toggle */}}
<script>
(function() {
  const toggle = document.getElementById('mobile-toggle');
  const nav = document.getElementById('mobile-nav');

  toggle.addEventListener('click', function() {
    nav.classList.toggle('tj-mobile-nav--open');
  });

  // Close on click outside
  document.addEventListener('click', function(e) {
    if (!nav.contains(e.target) && !toggle.contains(e.target)) {
      nav.classList.remove('tj-mobile-nav--open');
    }
  });
})();
</script>

{{/* Header search toggle */}}
<script>
(function() {
  const searchContainer = document.getElementById('header-search');
  const searchToggle = document.getElementById('search-toggle');
  const searchInput = document.getElementById('header-search-input');

  if (!searchToggle || !searchContainer) return;

  searchToggle.addEventListener('click', function() {
    searchContainer.classList.toggle('tj-header__search--open');
    if (searchContainer.classList.contains('tj-header__search--open')) {
      searchInput.focus();
    }
  });

  // Close on click outside
  document.addEventListener('click', function(e) {
    if (!searchContainer.contains(e.target)) {
      searchContainer.classList.remove('tj-header__search--open');
    }
  });

  // Close on Escape key
  searchInput.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      searchContainer.classList.remove('tj-header__search--open');
      searchToggle.focus();
    }
  });
})();
</script>

{{/* TOC toggle for mobile */}}
<script>
(function() {
  const tocHeaders = document.querySelectorAll('.tj-article-toc__header');

  tocHeaders.forEach(function(header) {
    header.addEventListener('click', function() {
      const toc = header.closest('.tj-article-toc');
      toc.classList.toggle('tj-article-toc--expanded');
    });
  });
})();
</script>

{{/* Copy code button */}}
<script>
(function() {
  var copyIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> Copy';
  var checkIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg> Copied!';

  // Language display names
  var langNames = {
    'powershell': 'PowerShell',
    'ps1': 'PowerShell',
    'pwsh': 'PowerShell',
    'bash': 'Bash',
    'sh': 'Shell',
    'shell': 'Shell',
    'zsh': 'Zsh',
    'javascript': 'JavaScript',
    'js': 'JavaScript',
    'typescript': 'TypeScript',
    'ts': 'TypeScript',
    'python': 'Python',
    'py': 'Python',
    'go': 'Go',
    'rust': 'Rust',
    'yaml': 'YAML',
    'yml': 'YAML',
    'json': 'JSON',
    'xml': 'XML',
    'html': 'HTML',
    'css': 'CSS',
    'scss': 'SCSS',
    'sql': 'SQL',
    'markdown': 'Markdown',
    'md': 'Markdown',
    'text': 'Text',
    'plaintext': 'Text'
  };

  // Find all highlight blocks
  var highlights = document.querySelectorAll('.highlight');

  highlights.forEach(function(wrapper) {
    if (wrapper.querySelector('.highlight__header')) return;

    // Find the code element - in table (line numbers) or direct pre
    var codeEl = wrapper.querySelector('.lntd:last-child code') ||
                 wrapper.querySelector('pre code');
    if (!codeEl) return;

    // Get language from data-lang attribute
    var lang = codeEl.getAttribute('data-lang') || '';
    var displayLang = langNames[lang.toLowerCase()] || lang.toUpperCase() || 'Code';

    // Create header bar
    var header = document.createElement('div');
    header.className = 'highlight__header';

    // Language label
    var label = document.createElement('span');
    label.className = 'highlight__label';
    label.textContent = displayLang;

    // Copy button
    var button = document.createElement('button');
    button.className = 'highlight__copy';
    button.type = 'button';
    button.innerHTML = copyIcon;

    button.addEventListener('click', function(e) {
      e.preventDefault();
      var code = (codeEl.innerText || codeEl.textContent).replace(/\n$/, '');

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(code).then(function() {
          button.innerHTML = checkIcon;
          setTimeout(function() { button.innerHTML = copyIcon; }, 2000);
        }).catch(function() {
          fallbackCopy(code);
        });
      } else {
        fallbackCopy(code);
      }

      function fallbackCopy(text) {
        var textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand('copy');
          button.innerHTML = checkIcon;
          setTimeout(function() { button.innerHTML = copyIcon; }, 2000);
        } catch (err) {
          console.error('Copy failed:', err);
        }
        document.body.removeChild(textarea);
      }
    });

    header.appendChild(label);
    header.appendChild(button);
    wrapper.insertBefore(header, wrapper.firstChild);
  });
})();
</script>

{{/* Random PowerShell tip */}}
{{ $randomTip := resources.Get "js/random-tip.js" }}
{{ if $randomTip }}
<script src="{{ $randomTip.RelPermalink }}"></script>
{{ end }}
